name: Notify Slack on Failure of Pages Deployment

on:
  workflow_run:
    workflows:
      - "pages-build-deployment" # GitHub Pagesのデプロイメント用Workflow
    types:
      - completed

jobs:
  notify-slack:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }} # デプロイが失敗した場合のみ実行
    runs-on: ubuntu-latest

    steps:
      - name: Extract repository name
        id: extract-repo-name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Send notification to Slack using Python
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          COMMIT_AUTHOR: ${{ github.event.workflow_run.actor }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_commit.id }}
          REPOSITORY_NAME: ${{ env.REPOSITORY_NAME }}
        run: |
          import requests
          import os
          import json  # jsonモジュールをインポート

          webhook_url = os.getenv('SLACK_WEBHOOK_URL')
          commit_author = os.getenv('COMMIT_AUTHOR')
          commit_sha = os.getenv('COMMIT_SHA')
          repository_name = os.getenv('REPOSITORY_NAME')

          message = {
              "text": f"🚨 GitHubActions DeployFailed! 🚨\n\n<{repository_name}>のデプロイに失敗しました。\n\n対象コミット: <{commit_sha}> by {commit_author}\n\n対応着手時・完了後、本チャンネルにて経緯を報告ください。"
          }

          response = requests.post(webhook_url, json=message)

          if response.status_code != 200:
              raise ValueError(f"Request to slack returned an error {response.status_code}, the response is: {response.text}")
