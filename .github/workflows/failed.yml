name: Notify Slack on Failure of Pages Deployment

on:
  workflow_run:
    workflows:
      - "pages-build-deployment" # GitHub Pagesã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç”¨Workflow
    types:
      - completed

jobs:
  notify-slack:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }} # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: Extract repository name
        id: extract-repo-name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Send notification to Slack using Python
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}  # GitHub Secretsã‹ã‚‰å–å¾—
          COMMIT_AUTHOR: ${{ github.event.workflow_run.actor }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_commit.id }}
          REPOSITORY_NAME: ${{ env.REPOSITORY_NAME }}
        run: |
          import requests
          import os
          import json

          # Slack Webhook URLã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
          webhook_url = os.getenv('SLACK_WEBHOOK_URL')
          
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
          payload = {
              "text": f"ğŸš¨ GitHubActions DeployFailed! ğŸš¨\n\n<{os.getenv('REPOSITORY_NAME')}>ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nå¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ: <{os.getenv('COMMIT_SHA')}> by {os.getenv('COMMIT_AUTHOR')}\n\nå¯¾å¿œç€æ‰‹æ™‚ãƒ»å®Œäº†å¾Œã€æœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã«ã¦çµŒç·¯ã‚’å ±å‘Šãã ã•ã„ã€‚"
          }

          # POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
          response = requests.post(
              webhook_url,
              data=json.dumps(payload),
              headers={'Content-Type': 'application/json'}
          )

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
          if response.status_code == 200:
              print("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ!")
          else:
              print(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {response.status_code} - {response.text}")
