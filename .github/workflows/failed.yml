name: Notify Slack on Failure of Pages Deployment

on:
  workflow_run:
    workflows:
      - "pages-build-deployment" # GitHub Pagesã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç”¨Workflow
    types:
      - completed

jobs:
  notify-slack:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }} # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: Extract repository name
        id: extract-repo-name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Send notification to Slack using Python
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          COMMIT_AUTHOR: ${{ github.event.workflow_run.actor }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_commit.id }}
          REPOSITORY_NAME: ${{ env.REPOSITORY_NAME }}
        run: |
          import requests
          import os
          import json  # jsonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

          webhook_url = os.getenv('SLACK_WEBHOOK_URL')
          commit_author = os.getenv('COMMIT_AUTHOR')
          commit_sha = os.getenv('COMMIT_SHA')
          repository_name = os.getenv('REPOSITORY_NAME')

          message = {
              "text": f"ğŸš¨ GitHubActions DeployFailed! ğŸš¨\n\n<{repository_name}>ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nå¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ: <{commit_sha}> by {commit_author}\n\nå¯¾å¿œç€æ‰‹æ™‚ãƒ»å®Œäº†å¾Œã€æœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã«ã¦çµŒç·¯ã‚’å ±å‘Šãã ã•ã„ã€‚"
          }

          response = requests.post(webhook_url, json=message)

          if response.status_code != 200:
              raise ValueError(f"Request to slack returned an error {response.status_code}, the response is: {response.text}")
