name: Notify Slack on Failure of Pages Deployment

on:
  workflow_run:
    workflows:
      - "pages-build-deployment" # GitHub Pagesã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç”¨Workflow
    types:
      - completed

jobs:
  notify-slack:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }} # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: Extract repository name
        id: extract-repo-name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Send notification to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          COMMIT_AUTHOR: ${{ github.event.workflow_run.actor }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_commit.id }}
          REPOSITORY_NAME: ${{ env.REPOSITORY_NAME }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "$(cat <<EOF
          {
            "text": "ğŸš¨ GitHubActions DeployFailed! ğŸš¨\n\n<${REPOSITORY_NAME}>ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nå¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ: <${COMMIT_SHA}> by ${COMMIT_AUTHOR}\n\nå¯¾å¿œç€æ‰‹æ™‚ãƒ»å®Œäº†å¾Œã€æœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã«ã¦çµŒç·¯ã‚’å ±å‘Šãã ã•ã„ã€‚"
          }
          EOF
          )" $SLACK_WEBHOOK_URL
